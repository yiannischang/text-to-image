<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <!--link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'-->
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="stylesheets/main.css" media="screen">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Text-to-image by yiannischang</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Text-to-image</h1>
          <h2></h2>
        </header>

        <!--section id="downloads" class="clearfix">
          <a href="https://github.com/yiannischang/text-to-image/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/yiannischang/text-to-image/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/yiannischang/text-to-image" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section-->

        <hr>

        <section id='text-to-image'>

        <div id='canvas'>
          <div id='w' contenteditable="true">请在此输入文字</div>
          <div id='gen-image'></div>
        </div>

        <input type="button" id="convert" value="生成图片" onclick="getimage();return false;"> 
        <div id="share-wb"></div>


        </section>
        <hr>
        <section id="main_content">
          <h3>使用方法
          </h3>

<p>
在上面文本框中输入你想转换的文字，点击“生成图片”按钮，文字区域会转换成图片，当处理完成时，会出现微博分享图标。鼠标右键点击，保存图片。重新编辑文字，点击“编辑文字”按钮。
</p>
        </section>

        <footer>
          Text-to-image is maintained by <a href="https://github.com/yiannischang">yiannischang</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>

    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="./javascripts/html2canvas.js"></script>
    <script src="./javascripts/md5-0.9.js"></script>


  <script>
  function getimage() {

    var elem = $('#w');

    if( $('#convert').val() === '生成图片'  ) {
    html2canvas($('#w').get(0), {
      allowTaint: true,  // cross domain images
      useCORS: true,
      onrendered: function(canvas) {
        $('#w').hide();
        $('#gen-image').append(canvas);
        $('#convert').val('修改文字');

        // save to server
        var d = canvas.toDataURL("image/png");
        var imagename = 'images/generated/' + d.md5() + '.png';
        var sha;

        //check if exists

  $.get('https://api.github.com/repos/yiannischang/text-to-image/contents/' + imagename, function (data) {
        load_share('https://raw.githubusercontent.com/yiannischang/text-to-image/gh-pages/' + imagename);
    })

  // not exists
  .fail(
        function() {
        $.ajax({
          headers: {
            Accept: 'application/vnd.github.v3.raw'
          },
          url: 'https://api.github.com/repos/yiannischang/text-to-image/contents/' + imagename + '?access_token=af1031d33c75febd29c2244fbabefbcfc2965a7a',
          type: 'PUT',
          contentType:'application/vnd.github.v3.raw',
          data: JSON.stringify( {
            "message": "generated image from http://yiannischang.github.io/text-to-image/",
            "committer": {
              "name": "anonymous",
              "email": "a@a.com"
            },
            "content": d.substring('data:image/png;base64,'.length)
            //"sha": ''
          }),
          success: function (data) {
            //成功则返回github上面的图片url，并加载分享图标
            load_share('https://raw.githubusercontent.com/yiannischang/text-to-image/gh-pages/' + imagename);
            console.log('ok');
          }
        });
     });

   },
      //width: 300,
      //height: 300
    });
   }
    else{
        $('#share-wb').empty();
        $('#gen-image').empty();
        $('#w').show();
        $('#convert').val('生成图片');

    }
  }

  //TODO: kinda *slow*
  function load_share(image_path) {

   var _w = 32 , _h = 32;
   var param = {
url:location.href,
    type:'3',
    count:'', /**是否显示分享数，1显示(可选)*/
    appkey:'', /**您申请的应用appkey,显示分享来源(可选)*/
    title:' ', /**分享的文字内容(可选，默认为所在页面的title)*/
    pic: image_path,
    ralateUid:'2141239811', /**关联用户的UID，分享微博会@该用户(可选)  That's me: @古典视丽 */
    language:'zh_cn', /**设置语言，zh_cn|zh_tw(可选)*/
    rnd:new Date().valueOf()
   };
   var temp = [];
   for( var p in param ){
     temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
   }
   $('#share-wb').html('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'"></iframe>')

  }

  </script>


</html>
