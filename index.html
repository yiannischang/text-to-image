<!DOCTYPE html>
<html xmlns:wb="http://open.weibo.com/wb">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <!--link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'-->
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="stylesheets/main.css" media="screen">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Text-to-image by yiannischang</title>

  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Text-to-image</h1>
          <h2></h2>
        </header>

        <!--section id="downloads" class="clearfix">
          <a href="https://github.com/yiannischang/text-to-image/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/yiannischang/text-to-image/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/yiannischang/text-to-image" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section-->

        <hr>
        <section id='text-to-image'>

        <div id='canvas'>
          <div id='w' contenteditable="true">请在此输入文字</div>
          <div id='gen-image'></div>
        </div>

        <input type="button" id="convert" value="生成图片" onclick="getimage();return false;">
        <input type="button" id="insert_abc" value="插入曲谱" onclick="insert_abc();return false;">
        <div id='wb-share'>
          <wb:share-button appkey="3qtHsl" addition="simple" type="button" picture_search="false"></wb:share-button>
        </div>

        </section>

        <hr>

        <!--textarea name="abc" id="abc" cols="80" rows="15">
X: 1
T: Cooley's
M: 4/4
L: 1/8
R: reel
K: Emin
|:D2|EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|
EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|
|:gf|eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|
eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2:|
        </textarea-->

        <hr />

        <div id="midi"></div>
        <div id="warnings"></div>
        <div id="music"></div>

        <canvas id="music_svg" style="display:none"></canvas>

        <input type="button" value="生成图片" onclick="save_svg();return false;">

        <hr>
        <section id="main_content">
          <h3>使用方法
          </h3>

<p>
在上面文本框中输入你想转换的文字，点击“生成图片”按钮，文字区域会转换成图片，当处理完成时，会出现微博分享图标。鼠标右键点击，保存图片。重新编辑文字，点击“编辑文字”按钮。
</p>
        </section>
        
        <footer>
          Text-to-image is maintained by <a href="https://github.com/yiannischang">yiannischang</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>


      </div>
    </div>
  </body>

    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="./javascripts/html2canvas.js"></script>
    <script src="./javascripts/jquery.getimagedata.min.js"></script>
    <script src="./javascripts/md5-0.9.js"></script>
    <script src="./javascripts/abcjs_editor_1.10-min.js"></script>
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/rgbcolor.js"></script> 
    <script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/StackBlur.js"></script>
    <script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/canvg.js"></script>

  <script>


  console.log(location.href);

  if(1/*TODO: 存在 pic 参数*/) { }


  $(function() {
      max_abcid = 0;
  });


/**
 * Convert an image 
 * to a base64 string
 * @param  {String}   url         
 * @param  {Function} callback    
 * @param  {String}   [outputFormat=image/png]           
 */
function convertImgToBase64(url, callback, outputFormat){
    var canvas = document.createElement('CANVAS'),
        ctx = canvas.getContext('2d'),
        img = new Image;
    img.crossOrigin = 'Anonymous';
    img.onload = function(){
        var dataURL;
        canvas.height = img.height;
        canvas.width = img.width;
        ctx.drawImage(img, 0, 0);
        dataURL = canvas.toDataURL(outputFormat);
        callback.call(this, dataURL);
        canvas = null; 
    };
    img.src = url;
}

//在文本输入框里面个插入 <textarea> 标签
function insert_abc() { 
  var abcid = ++max_abcid;
  console.log(abcid);
  $('#w').append('<div id="abc-' + abcid + '" class="abc"><textarea id="score-' + abcid + '"></textarea><div id="paper-' + abcid + '"></div></div><br>');
  // focus in
  $('#score-'+abcid).focus();
  abc_editor = new ABCJS.Editor("score-"+abcid, { paper_id: "paper-"+abcid, midi_id:"midi", warnings_id:"warnings" });
}


function render() {
  console.log('start render');
  var elem = $('#w');

  //将svg数据导入到canvas中，因为html2canvas不支持svg
  $('.abc').each(function(index) {
    canvg('music_svg', $('div', this).html());

    //将svg转成png数据，并添加到dom中
    var canvas = $('#music_svg').get(0);
    var img = canvas.toDataURL('image/png');
    var imagename = 'images/generated/' + img.md5() + '.png';
    var sha;

    $(this).hide();
    $(this).after('<img class="abc_img" src="' + img + '"></img>');
  });

  //check svg
  html2canvas(elem.get(0), {
    allowTaint: true,  // cross domain images
    useCORS: true,
    logging: true,
    onrendered: function(canvas) {

      // save to server
      var d = canvas.toDataURL("image/png");
      var imagename = 'images/generated/' + d.md5() + '.png';
      var sha;

      //check if exists
      $.get('https://api.github.com/repos/yiannischang/text-to-image/contents/' + imagename, function (data) {
            load_share('https://raw.githubusercontent.com/yiannischang/text-to-image/gh-pages/' + imagename);
        })

      // not exists
      .fail(
            function() {
            $.ajax({
              headers: {
                Accept: 'application/vnd.github.v3.raw'
              },
              url: 'https://api.github.com/repos/yiannischang/text-to-image/contents/' + imagename + '?access_token=af1031d33c75febd29c2244fbabefbcfc2965a7a',
              type: 'PUT',
              contentType:'application/vnd.github.v3.raw',
              data: JSON.stringify( {
                "message": "generated image from http://yiannischang.github.io/text-to-image/",
                "committer": {
                  "name": "anonymous",
                  "email": "a@a.com"
                },
                "content": d.substring('data:image/png;base64,'.length)
                //"sha": ''
              }),
              success: function (data) {
                //成功则返回github上面的图片url，并加载分享图标
                load_share('https://raw.githubusercontent.com/yiannischang/text-to-image/gh-pages/' + imagename);
                console.log('ok');
              }
            });
         });

      $('#w').hide();
      $('#gen-image').append(canvas);
      $('#convert').prop('disable', false).val('修改文字');
     },
    //width: 300,
    //height: 300
  });
}


function getimage() {

  if( $('#convert').val() === '生成图片'  ) {
    console.log('gen image');
    $('#convert').prop('disable', true);

    //check cross domain
    var cross_images = $('img').filter(function (idx) {
        return $(this).attr('src').substr(0, 4) === 'http'; 
     });

    if( cross_images.length == 0 ) {
      render();
    } 
    else {
      var succeed = 0; // number of images data received successful
      var failed  = 0; // number of images data received failed
      cross_images.each(function(idx) {
        var url = $(this).attr('src');
        var that = this;
        console.log('cors: ' + url);

        $.getImageData({
            url: url,
            //server: 'http://127.0.0.1:8080/',
            server: 'http://iproxy.sinaapp.com',
            success: function(image){ 
              $(that).attr('src', image.src);
              
              ++succeed;
              console.log('images: ' + (succeed+failed) + '/' + cross_images.length + ' (failed: ' + failed + ')' )
              if( succeed+failed == cross_images.length )
                render();
            },
            error: function(xhr, text_status){
              ++failed;
              console.log('images: ' + (succeed+failed) + '/' + cross_images.length + ' (failed: ' + failed + ')' )
              if( succeed+failed == cross_images.length )
                render();
            }
         });
       });
    }
  }

  else{
    console.log('edit');
    $('#wb-share').hide();
    $('#gen-image').empty();
    $('.abc_img').remove();
    $('.abc').show();
    $('#w').show();
    $('#convert').val('生成图片');
  }
}

//TODO: kinda *slow*
function load_share(image_path) {

  var iframe = $('wb\\:share-button iframe');
  var src = iframe.attr('src');
  iframe.attr('src', src + encodeURI('&pic='+image_path) );
  console.log('pic path updated');
   $('#wb-share').show();
/*
   var _w = 32 , _h = 32;
   var param = {
    url:location.href,
    type:'3',
    count:'', 
    appkey:'',
    title:' ',
    pic: image_path,
    ralateUid:'2141239811',
    language:'zh_cn',
    rnd:new Date().valueOf()
   };
   var temp = [];
   for( var p in param ){
     temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
   }
   $('#wb-share').html('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'"></iframe>')
*/
  }

  </script>


</html>
